#!/usr/bin/env bash

OPENCODE_PORT_START="${OPENCODE_PORT:-4096}"
OPENCODE_PORT_MAX=$((OPENCODE_PORT_START + 10))

# 1. Simple binary discovery
SCRIPT_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/$(basename "${BASH_SOURCE[0]}")"
OPENCODE_BIN="$(which -a opencode 2>/dev/null | grep -v "$SCRIPT_PATH" | head -1)"

if [ -z "$OPENCODE_BIN" ]; then
    if [ -x "$HOME/.opencode/bin/opencode" ]; then
        OPENCODE_BIN="$HOME/.opencode/bin/opencode"
    fi
fi

if [ -z "$OPENCODE_BIN" ]; then
    echo "âŒ Error: Could not find 'opencode' binary."
    exit 1
fi

# 2. Simple port check
check_port() {
    local port=$1
    if command -v lsof >/dev/null 2>&1; then
        lsof -i ":$port" -sTCP:LISTEN -t >/dev/null 2>&1
        return $?
    elif command -v nc >/dev/null 2>&1; then
        nc -z localhost "$port" >/dev/null 2>&1
        return $?
    else
        curl -s "http://localhost:$port/health" >/dev/null 2>&1
        return $?
    fi
}

find_available_port() {
    local port=$OPENCODE_PORT_START
    while [ $port -le $OPENCODE_PORT_MAX ]; do
        if ! check_port "$port"; then
            echo "$port"
            return 0
        fi
        port=$((port + 1))
    done
    exit 1
}

AVAILABLE_PORT=$(find_available_port)
if [ -z "$AVAILABLE_PORT" ]; then
    echo "âŒ No ports available."
    exit 1
fi

if [ "$AVAILABLE_PORT" != "$OPENCODE_PORT_START" ]; then
    echo "âš ï¸  Port $OPENCODE_PORT_START is in use, using port $AVAILABLE_PORT instead"
fi

export OPENCODE_PORT="$AVAILABLE_PORT"

# 3. Simple execution logic
if [ -n "$TMUX" ]; then
    # Already in tmux? Just run it.
    exec "$OPENCODE_BIN" --port "$AVAILABLE_PORT" "$@"
else
    # Not in tmux? Launch new session.
    # Use bash -l to ensure PATH is correct, but keep the command string simple.
    # We escape only the binary path to be safe.
    SAFE_BIN=$(printf %q "$OPENCODE_BIN")
    
    echo "ðŸš€ Launching tmux session..."
    # Launch bash -l -> run command || wait for input on error
    exec tmux new-session "bash -l -c '$SAFE_BIN --port $AVAILABLE_PORT $* || { echo \"Exit code: \$?\"; read -p \"Press Enter...\"; }'"
fi
